# This is a basic workflow that is manually triggered

name: Deploy test

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on: workflow_dispatch

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "greet"
  deploy:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Install ansible
        run: sudo apt-get install ansible
      - name:  Create env files
        run: |
          mkdir -p .envs/.production
          touch .envs/.production/.ipharm_app
          echo "SECRET_KEY=${{ secrets.TEST_IPHARM_SECRET_KEY }}" >>  .envs/.production/.ipharm_app
          echo "ALLOWED_HOSTS=${{ secrets.TEST_IPHARM_DOMAIN }}" >>  .envs/.production/.ipharm_app
          echo "SENTRY_DSN=${{ secrets.TEST_IPHARM_SENTRY_DSN }}" >>  .envs/.production/.ipharm_app
          echo SENTRY_ENVIRONMENT=test >>  .envs/.production/.ipharm_app
          echo LOG_LEVEL=DEBUG >>  .envs/.production/.ipharm_app
          echo "REFERENCES_TOKEN=${{ secrets.TEST_IPHARM_REFERENCES_TOKEN }}" >>  .envs/.production/.ipharm_app
          echo "BASE_PATIENT_URL=${{ secrets.TEST_BASE_PATIENT_URL }}" >>  .envs/.production/.ipharm_app
          echo "BASE_REFERENCES_URL=${{ secrets.TEST_IPHARM_BASE_REFERENCES_URL }}" >>  .envs/.production/.ipharm_app
          touch .envs/.production/.ipharm_postgres
          echo POSTGRES_HOST=ipharm_postgres >>  .envs/.production/.ipharm_postgres
          echo POSTGRES_PORT=5432 >>  .envs/.production/.ipharm_postgres
          echo POSTGRES_DB=ipharm >>  .envs/.production/.ipharm_postgres
          echo POSTGRES_USER=ipharm >>  .envs/.production/.ipharm_postgres
          echo "POSTGRES_PASSWORD=${{ secrets.TEST_IPHARM_POSTGRES_PASSWORD }}" >>  .envs/.production/.ipharm_postgres
          touch .envs/.production/.ipharm_redis
          echo REDIS_HOST=ipharm-redis >>  .envs/.production/.ipharm_redis
          echo REDIS_PORT=6379 >>  .envs/.production/.ipharm_redis
          echo CELERY_BROKER_URL=redis://ipharm-redis:6379/1 >>  .envs/.production/.ipharm_redis
          echo "FLOWER_BASIC_AUTH=${{ secrets.TEST_IPHARM_FLOWER_AUTH }}" >>  .envs/.production/.ipharm_redis
          touch .envs/.production/.iciselniky_app
          echo "SECRET_KEY=${{ secrets.TEST_ICISELNIKY_SECRET_KEY }}" >>  .envs/.production/.iciselniky_app
          echo "ALLOWED_HOSTS=${{ secrets.TEST_ICISELNIKY_DOMAIN }}" >>  .envs/.production/.iciselniky_app
          echo "SENTRY_DSN=${{ secrets.TEST_ICISELNIKY_SENTRY_DSN }}" >>  .envs/.production/.iciselniky_app
          echo SENTRY_ENVIRONMENT=test >>  .envs/.production/.iciselniky_app
          echo LOG_LEVEL=DEBUG >>  .envs/.production/.iciselniky_app
          echo "REFERENCES_TOKEN=${{ secrets.TEST_ICISELNIKY_REFERENCES_TOKEN }}" >>  .envs/.production/.iciselniky_app
          echo "BASE_REFERENCES_URL=${{ secrets.TEST_ICISELNIKY_BASE_REFERENCES_URL }}" >>  .envs/.production/.iciselniky_app
          echo "DIAGNOSES_URL=${{ secrets.TEST_ICISELNIKY_DIAGNOSES_URL }}" >>  .envs/.production/.iciselniky_app
          echo "MEDICAL_FACILITIES_URL=${{ secrets.TEST_ICISELNIKY_MEDICAL_FACILITIES_URL }}" >>  .envs/.production/.iciselniky_app
          touch .envs/.production/.iciselniky_postgres
          echo POSTGRES_HOST=iciselniky_postgres >>  .envs/.production/.iciselniky_postgres
          echo POSTGRES_PORT=5432 >>  .envs/.production/.iciselniky_postgres
          echo POSTGRES_DB=iciselniky >>  .envs/.production/.iciselniky_postgres
          echo POSTGRES_USER=iciselniky >>  .envs/.production/.iciselniky_postgres
          echo "POSTGRES_PASSWORD=${{ secrets.TEST_ICISELNIKY_POSTGRES_PASSWORD }}" >>  .envs/.production/.iciselniky_postgres
          touch .envs/.production/.iciselniky_redis
          echo REDIS_HOST=iciselniky-redis >>  .envs/.production/.iciselniky_redis
          echo REDIS_PORT=6379 >>  .envs/.production/.iciselniky_redis
          echo CELERY_BROKER_URL=redis://iciselniky-redis:6379/1 >>  .envs/.production/.iciselniky_redis
          touch .envs/.production/.nginx
          echo "IPHARM_DOMAIN=${{ secrets.TEST_IPHARM_DOMAIN }}" >>  .envs/.production/.nginx
          echo "ICISELNIKY_DOMAIN=${{ secrets.TEST_ICISELNIKY_DOMAIN }}" >>  .envs/.production/.nginx
      - name: Create key
        run: |
          mkdir ~/.ssh/
          touch ~/.ssh/ed25519
          chmod 600 ~/.ssh/ed25519
          echo "${{ secrets.TEST_PRIVATE_KEY }}" >>  ~/.ssh/ed25519
      - name: Create ansible inventory file
        run: |
          touch hosts
          echo "[ipharm]" >> hosts
          echo "${{ secrets.TEST_HOST }} ansible_user=${{ secrets.TEST_USER }} ansible_ssh_private_key_file=~/.ssh/ed25519 project_dir=${{ secrets.TEST_PROJECT_DIRECTORY }}" >> hosts
      - name: Deploy
        run: |
          export ANSIBLE_HOST_KEY_CHECKING=False
          ansible-playbook -i hosts -v deploy_production.yml
